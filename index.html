<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stopwatch</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      color: #FEFFC4;
      text-align: center;
      padding: 20px;
    }
    #time {
      font-size: 3em;
      margin-bottom: 20px;
      color: #799EFF;
    }
    button {
      font-size: 1.2em;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #startBtn { background-color: #799EFF; color: #191919; }
    #stopBtn  { background-color: #FEFFC4; color: #191919; }
    #resetBtn { background-color: #FFDE63; color: #191919; }
  </style>
</head>
<body>
  <div id="time">00:00:00</div>
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>
  <button id="resetBtn">Reset</button>

  <script>
    const MAX_TIME = 3 * 60 * 60 * 1000; // 3 hours in ms
    const urlParams = new URLSearchParams(window.location.search);
    const stopwatchId = urlParams.get("id") || "default";

    const { createClient } = supabase;
    const supabaseClient = createClient(
      "https://atqirggcezkmajfpvkhg.supabase.co",
      "YOUR_ANON_KEY_HERE"
    );

    let elapsed = 0;
    let startTime = null;
    let timerInterval = null;

    const timeDisplay = document.getElementById("time");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");

    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      let hours = Math.floor(totalSeconds / 3600);
      let minutes = Math.floor((totalSeconds % 3600) / 60);
      let seconds = totalSeconds % 60;
      return (
        String(hours).padStart(2, "0") + ":" +
        String(minutes).padStart(2, "0") + ":" +
        String(seconds).padStart(2, "0")
      );
    }

    function updateDisplay() {
      let currentElapsed = elapsed;
      if (startTime) currentElapsed += Date.now() - startTime;
      if (currentElapsed > MAX_TIME) currentElapsed = MAX_TIME;
      timeDisplay.textContent = formatTime(currentElapsed);
    }

    function start() {
      if (!startTime) {
        startTime = Date.now();
        timerInterval = setInterval(updateDisplay, 500);
      }
    }

    function stop() {
      if (startTime) {
        elapsed += Date.now() - startTime;
        startTime = null;
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function reset() {
      elapsed = 0;
      startTime = null;
      clearInterval(timerInterval);
      timerInterval = null;
      updateDisplay();
    }

    // Save elapsed time to Supabase every 5 seconds
    async function saveElapsed() {
      let currentElapsed = elapsed;
      if (startTime) currentElapsed += Date.now() - startTime;
      if (currentElapsed > MAX_TIME) currentElapsed = MAX_TIME;

      const { data, error } = await supabaseClient
        .from("stopwatches")
        .upsert({ id: stopwatchId, elapsed: currentElapsed });

      if (error) console.error("Save error:", error);
    }

    // Load elapsed time on page load
    async function loadElapsed() {
      const { data, error } = await supabaseClient
        .from("stopwatches")
        .select("elapsed")
        .eq("id", stopwatchId)
        .single();

      if (error && error.code !== "PGRST116") console.error("Load error:", error);
      if (data && data.elapsed !== undefined) elapsed = data.elapsed;
      updateDisplay();
    }

    // Event listeners
    startBtn.addEventListener("click", start);
    stopBtn.addEventListener("click", stop);
    resetBtn.addEventListener("click", reset);

    // Auto-save every 5 seconds
    setInterval(saveElapsed, 5000);

    // Load initial value
    loadElapsed();
  </script>
</body>
</html>
