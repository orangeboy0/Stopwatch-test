<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stopwatch</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      color: #FEFFC4;
      text-align: center;
      padding: 20px;
    }
    #time {
      font-size: 3em;
      margin-bottom: 20px;
      color: #799EFF;
    }
    button {
      font-size: 1.2em;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #startBtn { background-color: #799EFF; color: #191919; }
    #stopBtn  { background-color: #FEFFC4; color: #191919; }
    #resetBtn { background-color: #FFDE63; color: #191919; }
    #saveBtn  { background-color: #FFBC4C; color: #191919; }
  </style>
</head>
<body>
  <div id="time">00:00:00</div>
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>
  <button id="resetBtn">Reset</button>
  <button id="saveBtn">Save</button>

  <script>
    const MAX_TIME = 3 * 60 * 60 * 1000; // 3 hours in ms
    const urlParams = new URLSearchParams(window.location.search);
    const stopwatchId = urlParams.get("id") || "default";

    const { createClient } = supabase;
    const supabaseClient = createClient("https://atqirggcezkmajfpvkhg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0cWlyZ2djZXprbWFqZnB2a2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNjcxNDgsImV4cCI6MjA3Mzg0MzE0OH0.KZJnvVkR7cfv9ln41Rk86yrfd1ZvN6mcv6ulrb7MXc8");

    let elapsed = 0;
    let startTime = null;
    let timerInterval = null;

    const timeDisplay = document.getElementById("time");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");
    const saveBtn = document.getElementById("saveBtn");

    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      let hours = Math.floor(totalSeconds / 3600);
      let minutes = Math.floor((totalSeconds % 3600) / 60);
      let seconds = totalSeconds % 60;
      return (
        String(hours).padStart(2, "0") + ":" +
        String(minutes).padStart(2, "0") + ":" +
        String(seconds).padStart(2, "0")
      );
    }

    function updateDisplay() {
      let currentElapsed = elapsed;
      if (startTime) {
        currentElapsed += Date.now() - startTime;
      }
      if (currentElapsed > MAX_TIME) {
        currentElapsed = MAX_TIME;
        stop();
      }
      timeDisplay.textContent = formatTime(currentElapsed);
    }

    function start() {
      if (!startTime) {
        startTime = Date.now();
        timerInterval = setInterval(updateDisplay, 500);
      }
    }

    function stop() {
      if (startTime) {
        elapsed += Date.now() - startTime;
        startTime = null;
        clearInterval(timerInterval);
        saveElapsed(); // auto save when stopped
      }
    }

    function reset() {
      elapsed = 0;
      startTime = null;
      clearInterval(timerInterval);
      updateDisplay();
      saveElapsed();
    }

    async function saveElapsed() {
      let currentElapsed = elapsed;
      if (startTime) {
        currentElapsed += Date.now() - startTime;
      }
      if (currentElapsed > MAX_TIME) currentElapsed = MAX_TIME;

      await supabaseClient
        .from("Stopwatches")
        .upsert({ id: stopwatchId, elapsed: currentElapsed });
    }

    async function loadElapsed() {
      let { data, error } = await supabaseClient
        .from("Stopwatches")
        .select("elapsed")
        .eq("id", stopwatchId)
        .single();

      if (data && data.elapsed) {
        elapsed = data.elapsed;
      } else {
        elapsed = 0;
      }
      updateDisplay();
    }

    // Button listeners
    startBtn.addEventListener("click", start);
    stopBtn.addEventListener("click", stop);
    resetBtn.addEventListener("click", reset);
    saveBtn.addEventListener("click", saveElapsed);

    // Auto-save every 10s
    setInterval(saveElapsed, 10000);

    // Load initial value
    loadElapsed();
  </script>
</body>
</html>
